name: ğŸ§¹ Destroy SkillBridge (EKS + API Gateway)

on:
    push:
        branches: [kill-em-all, "feature/automated-deployment-setup"]

env:
    AWS_REGION: ap-southeast-1
    STACK_NAME: skillbridge-stack

jobs:
    destroy:
        runs-on: ubuntu-latest
        steps:
            - name: âš™ï¸ Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: ğŸ” Identify Cluster and Configure kubectl (best-effort)
              continue-on-error: true
              run: |
                  echo "ğŸ” Checking for existing EKS cluster in stack: $STACK_NAME ..."
                  CLUSTER=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
                    --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" --output text 2>/dev/null || true)
                  if [ -n "$CLUSTER" ]; then
                    echo "âœ… Found cluster: $CLUSTER"
                    aws eks update-kubeconfig --name $CLUSTER --region $AWS_REGION || true
                  else
                    echo "âš ï¸ No EKS cluster output found in stack $STACK_NAME"
                  fi

            - name: ğŸ§¨ Delete Kubernetes Resources
              continue-on-error: true
              run: |
                  echo "ğŸ§¨ Deleting Kubernetes resources if they exist..."
                  kubectl delete -f k8s/edge-nginx-deployment.yaml --ignore-not-found
                  kubectl delete -f k8s/edge-nginx-configmap.yaml --ignore-not-found
                  sed "s|\${AWS_ACCOUNT_ID}|${{ secrets.AWS_ACCOUNT_ID }}|g" k8s/services-deployments.yaml | kubectl delete -f - --ignore-not-found
                  kubectl delete -f k8s/namespace.yaml --ignore-not-found
                  echo "âœ… K8s cleanup attempted (ignored missing resources)."

            - name: ğŸŒ Delete API Gateway Stack
              continue-on-error: true
              run: |
                  echo "ğŸŒ Checking for API Gateway stack..."
                  aws cloudformation describe-stacks --stack-name ${STACK_NAME}-apigw --region $AWS_REGION >/dev/null 2>&1
                  if [ $? -eq 0 ]; then
                    echo "ğŸ—‘ï¸ Deleting API Gateway stack: ${STACK_NAME}-apigw"
                    aws cloudformation delete-stack --stack-name ${STACK_NAME}-apigw
                    echo "â³ Waiting for ${STACK_NAME}-apigw deletion to complete..."
                    aws cloudformation wait stack-delete-complete --stack-name ${STACK_NAME}-apigw --region $AWS_REGION || true
                    echo "âœ… API Gateway stack deletion finished."
                  else
                    echo "âš ï¸ API Gateway stack not found. Skipping."
                  fi

            - name: ğŸ§± Delete Core CloudFormation Stack
              run: |
                  echo "ğŸ§± Checking for core stack: $STACK_NAME"
                  aws cloudformation describe-stacks --stack-name $STACK_NAME --region $AWS_REGION >/dev/null 2>&1
                  if [ $? -eq 0 ]; then
                    echo "ğŸ—‘ï¸ Deleting CloudFormation stack: $STACK_NAME"
                    aws cloudformation delete-stack --stack-name $STACK_NAME
                    echo "â³ Waiting for $STACK_NAME deletion to complete..."
                    aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME --region $AWS_REGION || true
                    echo "âœ… Core stack deletion finished."
                  else
                    echo "âš ï¸ Core stack not found. Skipping."
                  fi

            - name: ğŸ§º Clean Up ECR Repositories (Optional)
              continue-on-error: true
              run: |
                  echo "ğŸ§º Cleaning up leftover ECR repositories..."
                  for repo in user-service booking-service availability-service search-service; do
                    echo "â†’ Checking for repository: $repo"
                    aws ecr describe-repositories --repository-names "$repo" --region $AWS_REGION >/dev/null 2>&1
                    if [ $? -eq 0 ]; then
                      echo "ğŸ—‘ï¸ Deleting ECR repository: $repo"
                      aws ecr delete-repository --repository-name "$repo" --region $AWS_REGION --force || true
                    else
                      echo "âš ï¸ Repository $repo not found."
                    fi
                  done
                  echo "âœ… ECR cleanup completed."

            - name: âœ… Final Status
              run: |
                  echo "ğŸ‰ All SkillBridge infrastructure cleanup steps completed."
                  echo "ğŸ’¡ Tip: Verify manually in AWS Console â†’ CloudFormation, ECR, and EKS to confirm all resources are gone."
